<!DOCTYPE html>
<html>

<head>
    <title>AI Agent Conversation Simulator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .graph-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>

<body class="min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">AI Agent Conversation Simulator</h1>
            <p class="text-gray-600">Monitor and analyze AI conversation patterns in real-time</p>
        </header>

        <div id="new-simulation" class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">Start New Simulation</h2>
            <form id="simulation-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone
                            Number</label>
                        <input type="text" name="phone_number" id="phone_number" required
                            class="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="agent_name" class="block text-sm font-medium text-gray-700 mb-1">Agent Name</label>
                        <input type="text" name="agent_name" id="agent_name" required
                            class="w-full px-4 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                    Start Simulation
                </button>
            </form>
        </div>

        <div id="active-simulations-container">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">Active Simulations</h2>
            <div id="active-simulations" class="grid grid-cols-1 gap-6">
                <!-- Simulations will be inserted here -->
            </div>
        </div>

        <!-- Template for simulation status cards -->
        <template id="simulation-card-template">
            <div class="simulation-card bg-white rounded-lg shadow-sm p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Simulation Status</h3>
                    <span class="epoch-counter text-sm text-gray-500">Epoch: 0</span>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full border-2 call-state-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="call-state text-sm font-medium">Call Status: Initializing...</div>
                            <div class="text-xs text-gray-500 call-state-details"></div>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full border-2 recording-state-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="recording-state text-sm font-medium">Recording: Waiting...</div>
                            <div class="text-xs text-gray-500 recording-state-details"></div>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full border-2 transcription-state-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="transcription-state text-sm font-medium">Transcription: Pending...</div>
                            <div class="text-xs text-gray-500 transcription-state-details"></div>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full border-2 analysis-state-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="analysis-state text-sm font-medium">Analysis: Pending...</div>
                            <div class="text-xs text-gray-500 analysis-state-details"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div id="graph-{phone_number}" class="graph-container">
                        <svg width="800" height="400"></svg>
                    </div>
                </div>
            </div>
        </template>

        <div class="graph-container">
            <h3>Conversation Graph</h3>
            <div id="graph-visualization"></div>
        </div>

    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        function updateGraph(phoneNumber) {
            $.get(`/graph/${phoneNumber}`, function (data) {
                if (data.status === 'success') {
                    visualizeGraph(data.graph, `graph-${phoneNumber}`);
                    // Update epoch counter if needed
                    const graphContainer = $(`#graph-${phoneNumber}`);
                    if (data.epoch) {
                        graphContainer.find('.epoch-counter').text(`Epoch: ${data.epoch}`);
                    }
                }
            }).fail(function (error) {
                console.error("Error fetching graph:", error);
            });
        }

        function visualizeGraph(graphData, containerId) {
            console.log("Visualizing graph for:", containerId, graphData);

            // Escape special characters in the container ID
            const escapedContainerId = containerId.replace(/[+]/g, '\\$&');
            const container = document.getElementById(containerId);
            if (!container) {
                console.error("Container not found:", containerId);
                return;
            }

            // Clear previous visualization
            container.innerHTML = '';

            // Initialize D3 visualization
            const width = 800;
            const height = 400;
            const margin = { top: 20, right: 120, bottom: 20, left: 120 };

            const svg = d3.select(`#${escapedContainerId}`)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            if (!graphData.nodes || graphData.nodes.length === 0) {
                svg.append('text')
                    .attr('x', (width - margin.left - margin.right) / 2)
                    .attr('y', (height - margin.top - margin.bottom) / 2)
                    .attr('text-anchor', 'middle')
                    .text('Building conversation graph...');
                return;
            }

            // Create the force simulation
            const simulation = d3.forceSimulation(graphData.nodes.map(id => ({ id })))
                .force('link', d3.forceLink(graphData.edges.map(([source, target]) => ({ source, target })))
                    .id(d => d.id))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter((width - margin.left - margin.right) / 2,
                    (height - margin.top - margin.bottom) / 2));

            // Add the links
            const links = svg.append('g')
                .selectAll('line')
                .data(graphData.edges)
                .enter()
                .append('line')
                .attr('class', 'link')
                .style('stroke', '#999')
                .style('stroke-width', 1);

            // Add the nodes
            const nodes = svg.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            nodes.append('circle')
                .attr('r', 5)
                .style('fill', '#69b3a2');

            nodes.append('text')
                .attr('dx', 12)
                .attr('dy', '.35em')
                .text(d => d);

            // Update positions on each tick
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodes
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        // Function to update specific status elements
        function updateStatus(phoneNumber, message) {
            console.log(`Updating status for ${phoneNumber}: ${message}`);
            const card = $(`#simulation-${phoneNumber}`);
            if (!card.length) {
                console.error(`Card not found for ${phoneNumber}`);
                return;
            }

            function updateIndicator(type, status, details = '') {
                const indicator = card.find(`.${type}-state-indicator`);
                const stateText = card.find(`.${type}-state`);
                const stateDetails = card.find(`.${type}-state-details`);

                indicator.removeClass('active completed error');
                indicator.addClass(status);

                if (stateText.length) stateText.text(message);
                if (stateDetails.length && details) stateDetails.text(details);
            }

            // Map backend status to frontend indicators
            if (message.includes('Call connected')) {
                updateIndicator('call-state', 'active', 'Call in progress...');
            } else if (message.includes('Call ended')) {
                updateIndicator('call-state', 'completed');
                updateIndicator('recording-state', 'active', 'Waiting for recording...');
            } else if (message.includes('Recording in progress')) {
                updateIndicator('recording-state', 'active', 'Recording conversation...');
            } else if (message.includes('Processing recording')) {
                updateIndicator('recording-state', 'completed');
                updateIndicator('transcription-state', 'active', 'Processing audio...');
            } else if (message.includes('Analyzing')) {
                updateIndicator('transcription-state', 'completed');
                updateIndicator('analysis-state', 'active', 'Analyzing conversation...');
            } else if (message === 'Completed') {
                updateIndicator('analysis-state', 'completed');
            }
        }

        // Add event source for status updates with reconnection logic
        function listenForUpdates(phoneNumber) {
            console.log("Starting to listen for updates for phone number:", phoneNumber);
            setInterval(function () {
                $.get(`/graph_status/${phoneNumber}`, function (response) {
                    console.log("Graph status response:", response);
                    if (response.status === 'success' && response.needs_update) {
                        updateGraphUI(phoneNumber);
                    }
                }).fail(function (error) {
                    console.error("Error fetching graph status:", error);
                });
            }, 3000);
        }

        // Remove any existing graph polling functions
        // Add new function for graph updates based on webhook
        function updateGraphFromWebhook(phoneNumber) {
            console.log("Checking graph update from webhook for phone number:", phoneNumber);
            $.get(`/graph_status/${phoneNumber}`, function (response) {
                console.log("Webhook graph status response:", response);
                if (response.status === 'success' && response.needs_update) {
                    updateGraph(phoneNumber);
                }
            }).fail(function (error) {
                console.error("Error fetching graph status from webhook:", error);
            });
        }

        function stopSimulation(phoneNumber) {
            $.get(`/stop_simulation/${phoneNumber}`, function (response) {
                if (response.status === 'success') {
                    $(`#simulation-${phoneNumber}`).remove();
                }
            });
        }

        // Add a function to update the UI when the graph is updated
        function updateGraphUI(phoneNumber) {
            console.log("Entering updateGraphUI for phone number:", phoneNumber);
            $.get(`/graph/${phoneNumber}`, function (response) {
                console.log("Graph response:", response);
                if (response.status === 'success') {
                    console.log("Graph data received:", response.graph);
                    const graphData = response.graph;
                    visualizeGraph(graphData, `graph-${phoneNumber}`);
                } else {
                    console.error("Failed to fetch graph data");
                }
            }).fail(function (error) {
                console.error("Error fetching graph:", error);
            });
        }

        $(document).ready(function () {
            $('#simulation-form').on('submit', function (event) {
                event.preventDefault(); // Prevent default form submission

                const phoneNumber = $('#phone_number').val();
                const agentName = $('#agent_name').val();

                $.post('/start_simulation', {
                    phone_number: phoneNumber,
                    prompt: agentName
                }, function (response) {
                    if (response.status === 'success') {
                        console.log('Simulation started successfully');

                        // Clone the template and append it to the active simulations
                        const template = $('#simulation-card-template').html();
                        const newCard = $(template).clone();
                        newCard.find('.call-state').text('Call Status: Initializing...');
                        newCard.find('.epoch-counter').text('Epoch: 0');
                        newCard.find('.graph-container').attr('id', `graph-${phoneNumber}`);
                        $('#active-simulations').append(newCard);

                        // Start listening for updates
                        listenForUpdates(phoneNumber);
                    } else {
                        console.error('Failed to start simulation:', response.message);
                    }
                }).fail(function (error) {
                    console.error('Error starting simulation:', error);
                });
            });
        });
    </script>

    <style>
        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }

        .node circle {
            fill: #fff;
            stroke: #4CAF50;
            stroke-width: 2px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .loading-spinner {
            display: inline-block;
        }

        .graph-container svg {
            background: white;
        }

        .node circle {
            fill: white;
            stroke: #4CAF50;
            stroke-width: 2px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1px;
        }

        /* Status indicators */
        .border-2 {
            transition: all 0.3s ease;
        }

        [class$="-state-indicator"] {
            border-color: #e5e7eb;
            color: #9ca3af;
        }

        [class$="-state-indicator"].active {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        [class$="-state-indicator"].completed {
            border-color: #10b981;
            color: #10b981;
            background-color: #d1fae5;
        }

        [class$="-state-indicator"].error {
            border-color: #ef4444;
            color: #ef4444;
            background-color: #fee2e2;
        }
    </style>
</body>

</html>